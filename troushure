#!/bin/sh

SCRIPT_NAME=`echo $0 | sed "s_/_\n_g" | tail -n 1`

# ID of first item added is 1
DB=$HOME/sites
SEPARATOR=" "

help() {
	echo "Usage: $SCRIPT_NAME"
	echo "\t- 	Read from standard input."
	echo "\t-a url	Add a url."
	echo "\t-p 	Print urls saved."
	echo "\t-d 	Delete all urls."
	echo "\t-d id	Delete url with ID."
	exit
}

add() {
	# Basic url validation
	echo $1 | grep -q  -E "https?://[0-9A-Za-z]+\..+"
	if [ $? -eq 1 ]; then
		echo "$1: Not a url."
		exit 1
	fi

	grep -q "$1" $DB
	if [ $? -eq 0 ]; then
		echo "$1: Already saved."
		exit
	fi

	# ID of first item added is 1
	ID=`expr $(tail -n 1 $DB | cut -d "$SEPARATOR" -f 1) + 1`
	echo "${ID}${SEPARATOR}$1" >> $DB
}

# Create list file if non existent.
if [ ! -e $DB ]; then
	touch $DB
fi

if [ $# -eq 0 ]; then
	help
fi

READ_STDIN=false
if [ $1 = "-" ]; then
	READ_STDIN=true
	shift
fi

while [ -n "$(echo $1 | grep '-')" ]; do
	case $1 in
		-h)
			help
			;;
		--help)
			help
			;;
		-a)
			if [ $2 ]; then
				add $2
				shift
			elif [ "$READ_STDIN" = true ]; then
				add $(cat /proc/${$}/fd/0)
			else
				echo "No url specified."
				exit 1
			fi
			;;
		-d)
			if [ ! $2 ]; then
				echo "This will delete the whole database.\nDo you want to continue(y/n):"
				read DEL_DB
				if [ "$DEL_DB" != "${DEL_DB#[Yy]}" ]; then
					rm $DB
				fi
				exit
			elif [ -z "$(echo $2 | sed 's/^[0-9][0-9]*//g')" ]; then
				TEXT=`sed "/^${2}${SEPARATOR}/d" $DB`
				echo "$TEXT" > $DB
				shift
			else
				echo "$2: Not an ID."
				exit 1
			fi
			;;
		-p)
			cat "$DB" | awk -F " " 'BEGIN { print "ID\tURL"} { print $1 "\t" $2}'
			exit
			;;
		*)
			echo "$SCRIPT_NAME: $OPTION: no such option."
			exit
			;;
	esac
	shift
done
