#!/bin/sh

# List websites and open them in one go
#Copyright (C) 2019  Karmjit Mahil
#
#This program is free software; you can redistribute it and/or
#modify it under the terms of the GNU General Public License 2
#as published by the Free Software Foundation.
#
#This program is distributed in the hope that it will be useful,
#but WITHOUT ANY WARRANTY; without even the implied warranty of
#MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#GNU General Public License for more details.
#
#You should have received a copy of the GNU General Public License
#along with this program; if not, write to the Free Software
#Foundation, Inc., 51 Franklin Street, Fifth Floor, Boston, MA  02110-1301, USA.

SCRIPT_NAME=`echo $0 | sed "s_/_\n_g" | tail -n 1`

# ID of first item added is 1
DB=$HOME/sites
SEPARATOR=" "

help() {
	echo "Usage: $SCRIPT_NAME"
	echo "\t- 	Read from standard input."
	echo "\t-a url	Add a url."
	echo "\t-p 	Print urls saved."
	echo "\t-d 	Delete all urls."
	echo "\t-d id	Delete url with ID."
	exit
}

add() {
	# Basic url validation
	echo $1 | grep -q  -E "https?://[0-9A-Za-z]+\..+"
	if [ $? -eq 1 ]; then
		echo "$1: Not a url."
		exit 1
	fi

	if grep -q "$1" $DB; then
		echo "$1: Already saved."
		exit
	fi

	# ID of first item added is 1
	ID=`expr $(tail -n 1 $DB | cut -d "$SEPARATOR" -f 1) + 1`
	echo "${ID}${SEPARATOR}$1" >> $DB
}

deleteDb() {
	echo "All url entries will be lost.\nDo you want to continue(y/n):"
	read DEL_DB
	if [ "$DEL_DB" != "${DEL_DB#[Yy]}" ]; then
		rm $DB
	fi
}

deleteUrl() {
	# Checks if $1 is an integer.
	if [ -z "$(echo $1 | sed 's/^[0-9][0-9]*//g')" ]; then
		TEXT=`sed "/^${1}${SEPARATOR}/d" $DB`
		echo "$TEXT" > $DB
	else
		echo "$2: Not an ID."
		exit 1
	fi
}

printUrls() {
	if [ -s $DB ]; then
		cat "$DB" | awk -F " " 'BEGIN { print "ID\tURL"} { print $1 "\t" $2}'
	else
		echo "No entries."
	fi
}

# Create list file if non existent.
if [ ! -e $DB ]; then
	touch $DB
fi

if [ $# -eq 0 ]; then
	help
fi

READ_STDIN=false
if [ $1 = "-" ]; then
	READ_STDIN=true
	shift
fi

while [ -n "$(echo $1 | grep '-')" ]; do
	case $1 in
		-h)
			help
			;;
		--help)
			help
			exit
			;;
		-a)
			if [ $2 ]; then
				add $2
				shift
			elif [ "$READ_STDIN" = true ]; then
				add $(cat /proc/${$}/fd/0)
			else
				echo "No url specified."
				exit 1
			fi
			;;
		-d)
			if [ ! $2 ]; then
				deleteDb
				exit
			else
				deleteUrl
				shift
			fi
			;;
		-p)
			printUrls
			exit
			;;
		*)
			echo "$SCRIPT_NAME: $OPTION: no such option."
			exit
			;;
	esac
	shift
done
